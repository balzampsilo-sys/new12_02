# Pool Autoscaling - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É–ª–∞

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

Pool Monitor - —ç—Ç–æ —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –ø—É–ª –±–æ—Ç–æ–≤**, –∫–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–Ω—å—à–µ –ø–æ—Ä–æ–≥–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
1. –°—Ç–∞—Ä—Ç —Å–∏—Å—Ç–µ–º—ã:
   ‚Ä¢ 10 –±–æ—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ WAITING
   ‚Ä¢ Pool Monitor –∑–∞–ø—É—â–µ–Ω

2. –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–∫—É–ø–∞—é—Ç:
   ‚Ä¢ Bot 1 ‚Üí ACTIVE
   ‚Ä¢ Bot 2 ‚Üí ACTIVE
   ‚Ä¢ ...
   ‚Ä¢ Bot 8 ‚Üí ACTIVE
   ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: 2 –±–æ—Ç–∞

3. Pool Monitor –æ–±–Ω–∞—Ä—É–∂–∏–ª:
   ‚ö†Ô∏è –°–≤–æ–±–æ–¥–Ω—ã—Ö –±–æ—Ç–æ–≤: 2 < 3 (MIN_FREE_BOTS)
   üöÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç 5 –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (SCALE_BATCH)

4. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   ‚Ä¢ –í—Å–µ–≥–æ: 15 –±–æ—Ç–æ–≤
   ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: 7 –±–æ—Ç–æ–≤
   ‚úÖ –ü—É–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í `docker-compose.pool.full.yml` –∏–ª–∏ `.env`:

```bash
# –ú–∏–Ω–∏–º—É–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–æ—Ç–æ–≤ (–ø–æ—Ä–æ–≥ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
MIN_FREE_BOTS=3

# –ú–∞–∫—Å–∏–º—É–º –±–æ—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
MAX_TOTAL_BOTS=100

# –°–∫–æ–ª—å–∫–æ –±–æ—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
SCALE_BATCH=5

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫—É–Ω–¥—ã)
CHECK_INTERVAL=30
```

### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

#### –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è (–º–∞–ª–µ–Ω—å–∫–∏–π –±–∏–∑–Ω–µ—Å)
```bash
MIN_FREE_BOTS=2
MAX_TOTAL_BOTS=20
SCALE_BATCH=2
CHECK_INTERVAL=60
```

#### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è)
```bash
MIN_FREE_BOTS=3
MAX_TOTAL_BOTS=100
SCALE_BATCH=5
CHECK_INTERVAL=30
```

#### –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è (–≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
```bash
MIN_FREE_BOTS=10
MAX_TOTAL_BOTS=500
SCALE_BATCH=20
CHECK_INTERVAL=15
```

## üöÄ –ó–∞–ø—É—Å–∫

Pool Monitor –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–æ–π:

```bash
./start_pool.sh
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Pool Monitor —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∞
docker-compose -f docker-compose.pool.full.yml logs -f pool-monitor

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# üîç POOL MONITOR STARTED
# ‚öôÔ∏è  Settings:
#    ‚Ä¢ Min free bots: 3
#    ‚Ä¢ Max total bots: 100
#    ‚Ä¢ Scale batch: 5
#    ‚Ä¢ Check interval: 30s
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç—É—Å –ø—É–ª–∞

```bash
# –ß–µ—Ä–µ–∑ Docker
docker-compose -f docker-compose.pool.full.yml ps | grep bot-pool

# –ß–µ—Ä–µ–∑ Redis
docker exec -it booking-redis redis-cli
KEYS bot_status:*
```

### –õ–æ–≥–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –¢–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
docker-compose -f docker-compose.pool.full.yml logs pool-monitor | grep "Scaling up"

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# ‚ö†Ô∏è  Low free bots detected: 2 < 3
# üöÄ Scaling up: adding 5 bots...
# üì¶ Creating container: booking-bot-pool-11
# ‚úÖ Container booking-bot-pool-11 started
# ...
# ‚úÖ Successfully added 5 bots
```

## üîß –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Pool Monitor

```bash
docker-compose -f docker-compose.pool.full.yml stop pool-monitor
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ

```bash
docker-compose -f docker-compose.pool.full.yml start pool-monitor
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

```bash
# –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ docker-compose.pool.full.yml
nano docker-compose.pool.full.yml

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose -f docker-compose.pool.full.yml up -d pool-monitor
```

## üö® Troubleshooting

### Pool Monitor –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–µ –±–æ—Ç—ã

**–ü—Ä–∏—á–∏–Ω–∞ 1:** –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Docker socket

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ volume —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
docker inspect booking-pool-monitor | grep docker.sock

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# "Source": "/var/run/docker.sock"
# "Destination": "/var/run/docker.sock"
```

**–ü—Ä–∏—á–∏–Ω–∞ 2:** –î–æ—Å—Ç–∏–≥–Ω—É—Ç MAX_TOTAL_BOTS

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs booking-pool-monitor | tail -20

# –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
# ‚ö†Ô∏è  Cannot scale: reached MAX_TOTAL_BOTS (100)

# –£–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç –≤ docker-compose.pool.full.yml
```

**–ü—Ä–∏—á–∏–Ω–∞ 3:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker —Ä–µ—Å—É—Ä—Å—ã
docker stats

# –ï—Å–ª–∏ CPU/Memory > 90%:
# ‚Ä¢ –£–≤–µ–ª–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã Docker
# ‚Ä¢ –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ MAX_TOTAL_BOTS
```

### –ë–æ—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è, –Ω–æ —Å—Ä–∞–∑—É –ø–∞–¥–∞—é—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
docker logs booking-bot-pool-11

# –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
# ‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π DATABASE_URL
# ‚Ä¢ Redis –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
# ‚Ä¢ –û—à–∏–±–∫–∞ –≤ main_pool.py
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –í–∞–∂–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

1. **Free bots ratio** - % —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–æ—Ç–æ–≤
   ```
   –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 20-30%
   –ö—Ä–∏—Ç–∏—á–Ω–æ: < 10%
   ```

2. **Scale events** - —á–∞—Å—Ç–æ—Ç–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
   ```
   –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 2-3 —Ä–∞–∑–∞ –≤ —á–∞—Å
   –ß–∞—Å—Ç–æ: > 10 —Ä–∞–∑ –≤ —á–∞—Å (—É–≤–µ–ª–∏—á—å—Ç–µ SCALE_BATCH)
   ```

3. **Activation lag** - –≤—Ä–µ–º—è –¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
   ```
   –¶–µ–ª—å: < 60 —Å–µ–∫—É–Ω–¥
   ```

## üí° Best Practices

### 1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

```
SCALE_BATCH ‚â• MIN_FREE_BOTS
```

–ü–ª–æ—Ö–æ: `MIN_FREE_BOTS=5`, `SCALE_BATCH=2` ‚Üí –±—É–¥–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è 3 —Ä–∞–∑–∞  
–•–æ—Ä–æ—à–æ: `MIN_FREE_BOTS=3`, `SCALE_BATCH=5` ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ 1 —Ä–∞–∑

### 2. –†–µ—Å—É—Ä—Å–Ω—ã–π –±–∞—Ñ—Ñ–µ—Ä

```
MAX_TOTAL_BOTS = –û–∂–∏–¥–∞–µ–º—ã–µ –∫–ª–∏–µ–Ω—Ç—ã √ó 1.5
```

–ü—Ä–∏–º–µ—Ä: –û–∂–∏–¥–∞–µ—Ç–µ 50 –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Üí `MAX_TOTAL_BOTS=75`

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã:
- ‚ö†Ô∏è Free bots < MIN_FREE_BOTS –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç
- üö® Scale events > 20 –≤ —á–∞—Å
- üö® Total bots > 90% MAX_TOTAL_BOTS

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—É–ª–∞ (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –±–æ—Ç–æ–≤)
- [ ] –ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana
- [ ] Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
- [ ] –ó–æ–Ω–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞/—Ä–µ–≥–∏–æ–Ω—ã)
