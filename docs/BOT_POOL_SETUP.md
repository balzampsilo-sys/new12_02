# Bot Pool System - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –ø—É–ª–∞ –±–æ—Ç–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞ 5-10 —Å–µ–∫—É–Ω–¥** –≤–º–µ—Å—Ç–æ 60-120 —Å–µ–∫—É–Ω–¥
- üéØ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ Deploy Worker –Ω–∞ —Ö–æ—Å—Ç–µ
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—É–ª –¥–æ 50-100 –±–æ—Ç–æ–≤
- üîÑ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –ø—Ä–æ–≥—Ä–µ—Ç—ã –∏ –≥–æ—Ç–æ–≤—ã

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL   ‚îÇ  Redis   ‚îÇ  10 Bot Pool     ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  bot-pool-1 (WAITING) ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  bot-pool-2 (WAITING)   ‚îÇ                   ‚îÇ
‚îÇ  bot-pool-3 (ACTIVE)    ‚îú‚îÄ‚Üí Redis Queue     ‚îÇ
‚îÇ  ...                    ‚îÇ                   ‚îÇ
‚îÇ  bot-pool-10 (WAITING) ‚îÄ‚îò                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üë                       ‚Üë
        ‚îÇ                       ‚îÇ
   Sales Bot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   (–æ–ø–ª–∞—Ç–∞ ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è)
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cd /path/to/new12_02
cp .env.example .env
nano .env
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
```bash
# PostgreSQL
POSTGRES_PASSWORD=YourSecurePassword123!

# Sales Bot
BOT_TOKEN_SALES=123456:ABC-your-sales-bot-token
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key

# Master Bot (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
BOT_TOKEN_MASTER=123456:ABC-your-master-bot-token
ADMIN_IDS_MASTER=123456789
```

### 2. –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

```bash
# –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x start_pool.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
./start_pool.sh
```

**–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:**
1. –û—Å—Ç–∞–Ω–æ–≤–∫—É —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
2. –°–±–æ—Ä–∫—É –æ–±—Ä–∞–∑–æ–≤
3. –ó–∞–ø—É—Å–∫ PostgreSQL –∏ Redis
4. –ó–∞–ø—É—Å–∫ 10 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–æ—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ WAITING

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
docker-compose -f docker-compose.pool.full.yml ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞
docker-compose -f docker-compose.pool.full.yml logs bot-pool-1

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# üïê BOT CONTAINER STARTED IN WAITING MODE
# ‚è≥ Waiting for configuration from Sales Bot...

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis
docker exec -it booking-redis redis-cli
# > KEYS bot_status:*
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 10 –∫–ª—é—á–µ–π
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

1. **–ö–ª–∏–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç –≤ Sales Bot:**
   - –í—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ
   - –°–æ–∑–¥–∞—ë—Ç –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather (–ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω)
   - –£–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–π Telegram ID
   - –û–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å—É

2. **Sales Bot –∏—â–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**
   ```python
   free_bot = await pool_manager.find_free_bot()
   # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {'container_id': 'booking-bot-pool-3', 'pool_id': '3'}
   ```

3. **Sales Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ Redis:**
   ```python
   await pool_manager.activate_bot(
       container_id='booking-bot-pool-3',
       bot_token='123456:ABC...',
       admin_telegram_id=987654321,
       client_id='client_003',
       company_name='–°–∞–ª–æ–Ω –ê–Ω–Ω—ã'
   )
   ```

4. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (—á–µ—Ä–µ–∑ 5 —Å–µ–∫):**
   - –ß–∏—Ç–∞–µ—Ç –∏–∑ Redis: `bot_config:booking-bot-pool-3`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –°–æ–∑–¥–∞—ë—Ç PostgreSQL schema: `client_003`
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é –ª–æ–≥–∏–∫—É –±–æ—Ç–∞

5. **–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
   ```
   üéâ –í–ê–® –ë–û–¢ –ì–û–¢–û–í!
   ü§ñ –ë–æ—Ç: @anna_salon_bot
   üìÖ –ü–æ–¥–ø–∏—Å–∫–∞: 30 –¥–Ω–µ–π
   ```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—É–ª–∞ —á–µ—Ä–µ–∑ Master Bot

```python
# –í Master Bot –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /pool
@dp.message(Command("pool"))
async def cmd_pool_status(message):
    status = await pool_manager.get_pool_status()
    # –ü–æ–∫–∞–∂–µ—Ç:
    # üèä –°–¢–ê–¢–£–° –ü–£–õ–ê –ë–û–¢–û–í
    # ‚ö™ –°–≤–æ–±–æ–¥–Ω–æ: 7/10
    # üü¢ –ó–∞–Ω—è—Ç–æ: 3/10
```

### –õ–æ–≥–∏

```bash
# –í—Å–µ –±–æ—Ç—ã
docker-compose -f docker-compose.pool.full.yml logs -f

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–æ—Ç
docker-compose -f docker-compose.pool.full.yml logs -f bot-pool-5

# –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
docker-compose -f docker-compose.pool.full.yml logs | grep "BOT ACTIVATED"
```

### Redis –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis
docker exec -it booking-redis redis-cli

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –±–æ—Ç–æ–≤
> KEYS bot_status:*

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
> GET bot_status:booking-bot-pool-3
# {"status":"active","client_id":"client_003","activated_at":"2026-02-15T19:30:00"}

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
> KEYS bot_config:*
```

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£–≤–µ–ª–∏—á–∏—Ç—å –ø—É–ª –¥–æ 20 –±–æ—Ç–æ–≤

–û—Ç–∫—Ä—ã—Ç—å `docker-compose.pool.full.yml` –∏ –¥–æ–±–∞–≤–∏—Ç—å:

```yaml
  bot-pool-11:
    build: .
    container_name: booking-bot-pool-11
    hostname: booking-bot-pool-11
    command: python main_pool.py
    environment:
      BOT_POOL_ID: "11"
      DATABASE_URL: postgresql://booking_user:${POSTGRES_PASSWORD}@postgres:5432/booking_saas
      REDIS_HOST: redis
    # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–æ bot-pool-20
```

**–û–±–Ω–æ–≤–∏—Ç—å –≤ –∫–æ–¥–µ:**
```python
# automation/bot_pool_manager.py
pool_manager = BotPoolManager(
    pool_size=20  # –ò–∑–º–µ–Ω–∏—Ç—å —Å 10 –Ω–∞ 20
)
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
docker ps | grep bot-pool

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs booking-bot-pool-3

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis
docker exec -it booking-redis redis-cli
> GET bot_config:booking-bot-pool-3

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL
docker exec -it booking-postgres psql -U booking_user -d booking_saas
# \dn - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ö–µ–º—ã
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Å–µ –±–æ—Ç—ã –∑–∞–Ω—è—Ç—ã

```bash
# –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –±–æ—Ç–æ–≤ –≤ docker-compose –∏–ª–∏
# –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ:

docker-compose -f docker-compose.pool.full.yml restart bot-pool-1
```

### –ü—Ä–æ–±–ª–µ–º–∞: Redis –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω
docker ps | grep redis

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs booking-redis

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose -f docker-compose.pool.full.yml restart redis
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –¢–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤
- –¢–æ–∫–µ–Ω—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Redis —Å TTL=300 —Å–µ–∫ (5 –º–∏–Ω—É—Ç)
- –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª—é—á —É–¥–∞–ª—è–µ—Ç—Å—è
- –ö–∞–∂–¥—ã–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π PostgreSQL schema

### PostgreSQL
- Multi-tenant —á–µ—Ä–µ–∑ schemas: `client_001`, `client_002`, ...
- –ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö

### Redis
- –ü—Ä–µ—Ñ–∏–∫—Å—ã –∫–ª—é—á–µ–π –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ FSM: `client_001:fsm:*`
- Rate limiting per client: `client_001:ratelimit:*`

## Production —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–£–≤–µ–ª–∏—á–∏—Ç—å –ø—É–ª –¥–æ 50-100 –±–æ—Ç–æ–≤** –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ Kubernetes
3. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —á–µ—Ä–µ–∑ Prometheus + Grafana
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã** –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—É–ª–∞ > 80%
5. **–ë—ç–∫–∞–ø—ã PostgreSQL** –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
6. **Redis Sentinel** –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—É–ª–∞ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –±–æ—Ç–æ–≤
- [ ] Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—É–ª–∞
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –≤ —á–∞—Å)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–æ—Ç–æ–≤ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] Health checks –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
