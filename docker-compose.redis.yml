version: '3.8'

# ========================================
# SHARED REDIS FOR ALL BOT INSTANCES
# ========================================
# This file creates a SINGLE Redis container
# that serves ALL bot clients using different DB numbers
#
# Usage:
#   docker-compose -f docker-compose.redis.yml up -d
#
# Each bot connects to this Redis with:
#   REDIS_HOST=redis-shared
#   REDIS_DB=0  (for client 1)
#   REDIS_DB=1  (for client 2)
#   ...
#   REDIS_DB=15 (for client 16)
#
# ========================================

services:
  redis-shared:
    image: redis:7-alpine
    container_name: booking-bot-redis-shared
    restart: unless-stopped
    
    # Expose port for external connections
    ports:
      - "6379:6379"
    
    # Persistent data storage
    volumes:
      - redis_shared_data:/data
    
    # Optimized Redis configuration
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --loglevel notice
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    
    # Network for all bots
    networks:
      - bot-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

# Persistent volume for Redis data
volumes:
  redis_shared_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/redis_data

# Shared network for all bot containers
networks:
  bot-network:
    name: bot-network
    driver: bridge
